<!DOCTYPE html>
<html>
<body>
	<style>
	body { padding-left: 10px; color: #000; }
	h2 { font-family:'Arial',sans-serif; font-size:2.0em; color:#999; }
	h3 {
		font-family:'Arial',sans-serif; font-size:1.6em;
		color:#114;
		margin:2px; padding-top:6px;
	}
	.box_border { border:2px solid #999; width:600px; padding-left:8px; }
	p { width:800px; }
	.indent { padding-left: 20px; }
	</style>

<h2>CMPS-224  Lab 9<br>Optimizing x86-64 Code</h2>
Gordon Griesel<br>
Department of Computer and Electrical Engineering and Computer Science<br>
California State University, Bakersfield<br>

<p>
<h3>Introduction</h3>
</p>
<p>
<b>Goals</b>:
Optimize x86-64 code using an implementation of Fibonacci.
</p>

<p>
<b>Resources</b>:

<ul>
<li>
<a href="https://en.wikipedia.org/wiki/X86-64">
AMD64 Wiki</a> at
https://en.wikipedia.org/wiki/X86-64.
</li>
<br>

<li>
<a href="http://www.x86-64.org/documentation/abi.pdf">
AMD64 abi.pdf (see pg 122)</a> at
http://www.x86-64.org/documentation/abi.pdf
</li>
<br>

<li>
<a href="http://www.x86-64.org/documentation/assembly.html">
AMD64 gentle intro</a> at
http://www.x86-64.org/documentation/assembly.html
</li>
<br>

<li>
<a href="http://asm.sourceforge.net/syscall.html#p32">
list of x86 system calls</a> at
http://asm.sourceforge.net/syscall.html#p32
</li>
<br>

<li>
<a href="http://vikaskumar.org/amd64/sample.htm">
sample x86-64 programs</a> at
http://vikaskumar.org/amd64/sample.htm
</li>
</ul>
</p>

<p>
<b>Files Needed for today's lab</b>:
</p>
<p>
<a href="http://cs.csubak.edu/~gordon/cs224/code/lab9/">Lab9 files</a> at
http://cs.csubak.edu/~gordon/cs224/code/lab9/
</p>



<p>
<h3>Technical Approach</h3>
</p>
<p>
Copy all example source files and the Makefile for lab 9 into your own
directory:
</p>
<p>
Your own directory is here: /home/stu/<i><b>you</b></i>/224/lab9/
</p>
<p>
Replace <i>you</i> with your Sleipnir username.
</p>
<p>
Get the lab files:
<pre class="indent"><b>$ cp /home/stu/gordon/public_html/cs224/code/lab9/* .
</b></pre>
From a local machine:
<pre class="indent"><b>$ scp sleipnir.cs.csubak.edu:/home/stu/gordon/public_html/cs224/code/lab9/* .
</b></pre>
</p>
<p>
Use the Makefile to assemble and link the sources. To make fib.c do this:
<pre class="indent"><b>$ make fib
</b></pre>
To remove the .o files and the executables do this:
<pre class="indent"><b>$ make clean
</b></pre>
</p>

<p>
Add an entry to your Makefile to assemble and link lab9.asm.
</p>

<p>
<h3>Lab steps</h3>
</p>
<p>
Your job is to write an x86-64 assembly program that computes fib(n),
where n is an integer &gt;= 1 passed in from the command line. The goal is to
produce an optimized program which is more efficient than the one produced by
the gcc compiler for the same algorithm.
</p>
<p>
Start by reviewing the <b>fib.c</b> algorithm in the lab 9 examples.
You will attempt to do a better job than the compiler. Compile fib.c to
view the ATT assembly that is produced by gcc front-end:
</p>

<pre class="indent"><b>$ gcc -S fib.c
</b></pre>

<p>
Note that GAS and NASM require different syntax! However, it will be
understandable given some effort. If you look at fib.s you will see that
the gcc compiler constructs a call frame for each recursive call to fib
(we already know how bad that is).
</p>
<p>
You need to write the x86-64 version from scratch. Do not try modifying the
assembly generated by gcc, it is in GAS. You are familiar with NASM.
Use the same optimization strategies that you used for MIPS optimization.
Most importantly, do not construct a call frame for stopping conditions;
i.e.,  when  n=1  or  n=2.
</p>
<p>
You can also streamline various other things but most improvement will be
seen by eliminating unnecessary stack frame constructions.
<i>If you're feeling adventurous you may want to implement an interative
	version of Fibonacci, but this is not required.</i>
</p>
<p>
Since grabbing a command line argument requires a conversion routine to
convert from a string to an integer you need to link in the gcc standard c
library and use atoi.
</p>
<p>
Here is an example of what is expected:
<pre class="indent"><b>$ time ./fib 42    # this is unoptimized code from the gcc compiler
433494437

real 0m4.808s
user 0m4.804s
sys 0m0.000s

$ time ./lab9 42   # this is hand-written optimized assembly code
433494437

real 0m2.449s
user 0m2.424s
sys 0m0.008s
</b>
</pre>
</p>
<p>
If you compile your C code with optimization flags you will come close to the
efficiency of optimized hand-written code but your code can still beat the
compiler!
<pre class="indent"><b>$ time ./fib 42    # this is optimized gcc code using -O2 flag
433494437

real 0m2.544s
user 0m2.524s
sys 0m0.004s
</b>
</pre>
</p>

<p>
<h3>3 The GNU Project Debugger (GBD)</h3>
</p>
<p>
The following section discusses how to use the debugger.  It is not required
to complete the lab, but may be helpful if you run into problems.
This is a tricky assignment.  But you will learn x86-64 if you spend the
time to complete it. Since the executable can be executed on sleipnir,
you can use the gdb debugger to debug your code. Assemble and link then
load the progrom into gdb:
</p>
<p>
<pre class="indent"><b>$ make lab9
$ gdb ./lab9
(gdb) set language asm
(gdb) break main
(gdb) run
(gdb) si                 # step one instruction
(gdb) disassemble $pc    # display code starting a program counter
(gdb) info registers
(gdb) p/d $ecx           # display value as a decimal number in reg ecx
(gdb) x/5i $pc           # examine 5 instructions past program counter
(gdb) cont
(gdb) ret                # return from another function
(gdb) exit
</b>
</pre>
</p>
<p>
Using the debugger will help you understand why your code is not working as
it should. Another option:
</p>
<p>
<pre class="indent"><b>gcc -g foo.c
$ gdb -tui  ./a.out
(gdb) layout split
(gdb) break main
(gdb) r
(gdb) s
(gdb) set disassembly-flavor intel
(gdb) next   # jump to next function
(gdb) exit
</b>
</pre>
</p>

<p>
All the code you need to complete this lab is in <b>myecho.asm</b> and
<b>fac.asm</b>. In particular, myecho.asm has the code to read an integer
from the cmdline, convert it into an integer and display it. Good luck!
</p>


<p>
<h3>What to turn in</h3>
<pre>
Your lab program <i><b>lab9.asm</b></i> must be in the correct directory on Sleipnir.
directory name: /home/stu/<i><b>you</b></i>/224/lab9/
Replace <i>you</i> with your own Sleipnir username!
</p>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>	
</body>
</html>

